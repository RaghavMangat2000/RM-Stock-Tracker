{% extends "base.html" %}

{% block title %}
  {{ index.slug }}
{% endblock %}

{% block content %}
<div class="pt-5 mt-5">

  <!-- Hero Section -->
  <section class="bg-light py-5 mb-5">
    <div class="container text-center">
      <h1 class="text-body-emphasis">{{ index.name }}</h1>
      <p class="lead col-lg-8 mx-auto mt-3">
        View the top stocks in this index along with their weight, performance, and 200-day moving average (DMA).
        Use the dropdown menu to sort the table by various parameters. Click on a stock name to see detailed information about that stock.
      </p>
      <p class="text-muted mt-4">
        Last Updated: {{ index.last_updated|format_et_datetime if index.last_updated else 'N/A' }}
      </p>
    </div>
  </section>

  <!-- Sort By Dropdown -->
  <div class="container text-end mb-4">
    <div class="dropdown">
      <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
        Sort By
      </button>
      <ul class="dropdown-menu">
        {% for option in dropdown_options %}
          <li>
            <a class="dropdown-item {% if sort_by == option.sort_by and order == option.order %}active{% endif %}"
               href="{% if option.sort_by and option.order %}
                        {{ url_for('show_index', index_id=index.slug, sort_by=option.sort_by, order=option.order) }}
                      {% else %}
                        {{ url_for('show_index', index_id=index.slug) }}
                      {% endif %}"
               {% if sort_by == option.sort_by and order == option.order %}aria-current="true"{% endif %}>
              {{ option.label }}
            </a>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- Data Table -->
  <div class="container mb-5">
    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th scope="col">#</th>
            <th scope="col">Name</th>
            <th scope="col">Ticker</th>
            <th scope="col">Weight</th>
            <th scope="col">Day Close</th>
            <th scope="col">200-DMA</th>
            <th scope="col">
              % Diff
              <span
                tabindex="0"
                class="ms-1 text-muted"
                role="button"
                data-bs-toggle="popover"
                data-bs-placement="top"
                data-bs-html="true"
                data-bs-trigger="focus"
                title="% Diff Explanation"
                data-bs-content="
                  <strong>What is it?</strong><br>
                  The percentage difference between the stock's Day Close and its 200-Day Moving Average (DMA).<br><br>
                  <strong>Color Coding:</strong><br>
                  <span>Dark Green</span>: ≥ +10%<br>
                  <span>Green</span>: +2% to +10%<br>
                  <span>Yellow</span>: -2% to +2%<br>
                  <span>Red</span>: -2% to -10%<br>
                  <span>Dark Red</span>: ≤ -10%">
                <i class="bi bi-question-circle-fill"></i>
              </span>
            </th>
          </tr>
        </thead>
        <tbody>
          {% for stock in index_data %}
          <tr>
            <th scope="row">{{ loop.index }}</th>
            <td>
              <a href="{{ url_for('show_stock', ticker=stock.ticker) }}" class="fw-semibold text-primary">
                {{ stock.stock_name }}
              </a>
            </td>
            <td>{{ stock.ticker }}</td>
            <td>{{ "{:,.2f}".format(stock.weight) }}%</td>
            <td>{{ "{:,.2f}".format(stock.last_close) }}</td>
            <td>{{ "{:,.2f}".format(stock.dma_200) }}</td>
            <td style="background-color: {{ stock.dma_200_perc_diff | stock_color }}; font-weight: bold">
              {{ "{:,.2f}".format(stock.dma_200_perc_diff) }}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}

{% block script %}
<!-- Initialize Bootstrap popovers -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
    popoverTriggerList.forEach(function (popoverTriggerEl) {
      new bootstrap.Popover(popoverTriggerEl)
    });
  });
</script>
{% endblock %}
